<!doctype html>
<html>

<head>
    <title>Leaflet GeoServer GetFeatureInfo</title>
    <link rel="stylesheet" href="assets/leaflet-0.7.3/leaflet.css">



    <style type="text/css">
        html,
        body,
        #map {
            margin: 0px;
            height: 100%;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script src="assets/jquery-1.11.1.min.js"></script>
    <script src="assets/leaflet-0.7.3/leaflet.js"></script>
    <script src="assets/leaflet.proj4/proj4-compressed.js"></script>
    <script src="assets/leaflet.proj4/proj4leaflet.js"></script>

    <script>
        var layerOSM = new L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            zIndex: 10,
            attribution: '&copy; Map Data <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });




        var geourl = 'http://134.249.136.27:8080/geoserver/gedit/wms';

        var layerBoundary = new L.TileLayer.WMS(geourl, {
            layers: 'gedit:boundary',
            format: 'image/png',
            //styles: 'osm_poi',
            transparent: true,
            attribution: '&copy; Map Data <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            zIndex: 10,
            opacity: 1
        });

        var layerBuildings = new L.TileLayer.WMS(geourl, {
            layers: 'gedit:buildings',
            format: 'image/png',
            //styles: 'osm_poi',
            transparent: true,
            attribution: '&copy; Map Data <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            zIndex: 11,
            opacity: 1
        });

        var layerRoads = new L.TileLayer.WMS(geourl, {
            layers: 'gedit:roads',
            format: 'image/png',
            //styles: 'osm_poi',
            transparent: true,
            attribution: '&copy; Map Data <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            zIndex: 11,
            opacity: 1
        });

        var layerPoint = new L.TileLayer.WMS(geourl, {
            layers: 'gedit:point',
            format: 'image/png',
            //styles: 'osm_poi',
            transparent: true,
            attribution: '&copy; Map Data <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            zIndex: 11,
            opacity: 1
        });




        var map = L.map('map', {
            layers: [layerBoundary, layerBuildings],
            center: [48.462426, 35.043664],
            zoom: 18
        });




        var baseLayer = {
            "Boundary": layerBoundary,
            "OpenStreetMap": layerOSM
        };
        var overlayLayer = {
            "Buildings": layerBuildings,
            "Roads": layerRoads,
            "Points": layerPoint

        };

        var layerControl = L.control.layers(baseLayer, overlayLayer, {
            collapsed: false
        }).addTo(map);




        function getBuildingsInfo(e) {

            var bbox = map.getBounds()._southWest.lng + "," + map.getBounds()._southWest.lat + "," + map.getBounds()._northEast.lng + "," + map.getBounds()._northEast.lat;



            $.ajax({
                    url: geourl,
                    dataType: 'xml',
                    data: {
                        'tiled': true,
                        'LAYERS': 'gedit:buildings',
                        'QUERY_LAYERS': 'gedit:buildings',
                        'STYLES': '',
                        'SERVICE': 'WMS',
                        'VERSION': '1.1.1',
                        'REQUEST': 'GetFeatureInfo',
                        'BBOX': bbox,
                        'FEATURE_COUNT': '1',
                        'WIDTH': map.getSize().x,
                        'HEIGHT': map.getSize().y,
                        'FORMAT': 'image/png',
                        'INFO_FORMAT': 'application/vnd.ogc.gml',
                        'SRS': 'EPSG:4326',
                        'X': map.layerPointToContainerPoint(e.layerPoint).x,
                        'Y': map.layerPointToContainerPoint(e.layerPoint).y
                    }
                })
                .done(function(data) {
                    if (data) {
                        var $xml = $(data);

                        var coords = $xml.find('gml\\:coordinates').text().split(' ');
                        var build = $xml.find('gedit\\:BUILDING, BUILDING').text();

                        var coordsnew = [];


                        var ca = $xml.find('gml\\:coordinates').text();
                        var cb = $xml.find('gml\\:coordinates').text().split(' ');

                        for (var i = 0; i < coords.length; i++) {
                            var coord = coords[i].split(',')
                            coordsnew.push(coord);
                        }
                        var cc = coordsnew;

                        console.log(ca);
                        // 35.043106,48.4620229 35.0433595,48.4622298 35.0435357,48.4621348 35.0432822,48.461928 35.043106,48.4620229
                        console.log(cb);
                        // ["35.043106,48.4620229", "35.0433595,48.4622298", "35.0435357,48.4621348", "35.0432822,48.461928", "35.043106,48.4620229"]			
                        console.log(cc);
                        // [["35.043106", "48.4620229"], ["35.0433595", "48.4622298"], ["35.0435357", "48.4621348"], ["35.0432822", "48.461928"], ["35.043106", "48.4620229"]]		




                        var popup = new L.popup({
                            maxWith: 500
                        });

                        popup.setContent(build);
                        popup.setLatLng(e.latlng);
                        map.openPopup(popup);




                        var poly = new L.rectangle(coordsnew, {
                            color: "#ff7800",
                            weight: 5
                        }).addTo(map);

                        //полигон получается, только нужно перевернуть координаты
                        // [["35.043106", "48.4620229"], ["35.0433595", "48.4622298"], ["35.0435357", "48.4621348"], ["35.0432822", "48.461928"], ["35.043106", "48.4620229"]]		




                    };
                });
        };




        function getPointInfo(e) {

            var bbox = map.getBounds()._southWest.lng + "," + map.getBounds()._southWest.lat + "," + map.getBounds()._northEast.lng + "," + map.getBounds()._northEast.lat;



            $.ajax({
                    url: geourl,
                    dataType: 'xml',
                    data: {
                        'tiled': true,
                        'LAYERS': 'gedit:point',
                        'QUERY_LAYERS': 'gedit:point',
                        'STYLES': '',
                        'SERVICE': 'WMS',
                        'VERSION': '1.1.1',
                        'REQUEST': 'GetFeatureInfo',
                        'BBOX': bbox,
                        'FEATURE_COUNT': '1',
                        'WIDTH': map.getSize().x,
                        'HEIGHT': map.getSize().y,
                        'FORMAT': 'image/png',
                        'INFO_FORMAT': 'application/vnd.ogc.gml',
                        'SRS': 'EPSG:4326',
                        'X': map.layerPointToContainerPoint(e.layerPoint).x,
                        'Y': map.layerPointToContainerPoint(e.layerPoint).y
                    }
                })
                .done(function(data) {
                    if (data) {
                        var $xml = $(data);

                        var coords = $xml.find('gml\\:coordinates').text().split(' ');
                        var build = $xml.find('gedit\\:NAME, NAME').text();

                        var coordsnew = [];


                        var ca = $xml.find('gml\\:coordinates').text();
                        var cb = $xml.find('gml\\:coordinates').text().split(' ');
						var cd = $xml.find('gml\\:coordinates').text().split(' ').toString();
						
						
                        for (var i = 0; i < coords.length; i++) {
                            var coord = coords[i].split(',')
                            coordsnew.push(coord);
                        }
                        var cc = coordsnew;

                        console.log(ca);
                        // 35.0419489,48.4625027
                        console.log(cb);
                        // ["35.0419489,48.4625027"]		
                        console.log(cc);
                        // [["35.0419489", "48.4625027"]]		
						console.log(cd);
						// 35.0424298,48.4622504

						
						
						


                        var popup = new L.popup({
                            maxWith: 500
                        });

                        popup.setContent(build);
                        popup.setLatLng(e.latlng);
                        map.openPopup(popup);

var kk = '['+ca+']';
//console.log(kk);



                        var circle = new L.circle(kk, 50, {
										color: 'red',
										fillColor: '#f03',
										fillOpacity: 0.5
									}).addTo(map);

						//var marker = L.marker([ca]).addTo(map);

                    };
                });
        };




        map.on("overlayadd", function(e) {
            if (e.layer === layerBuildings) {
                map.addEventListener('click', getBuildingsInfo);
            }
            if (e.layer === layerPoint) {
                map.addEventListener('click', getPointInfo);
            }
        });
        map.on("overlayremove", function(e) {
            if (e.layer === layerBuildings) {
                map.removeEventListener('click', getBuildingsInfo);
            }
            if (e.layer === layerPoint) {
                map.removeEventListener('click', getPointInfo);
            }
        });
    </script>

</body>

</html>