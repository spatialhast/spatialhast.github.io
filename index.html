<!doctype html>
<html>

<head>
    <title>WMS GetFeatureInfo</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
    <![endif]-->

    <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <style type="text/css">
        html,
        body,
        #map {
            margin: 0px;
            height: 100%;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script>
        var map = L.map('map', {
            center: [46.75, 33.77],
            layers: [layer_soil_wms_dem_mn],
            zoom: 9
        });


        L.tileLayer('http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
            subdomains: ["otile1", "otile2", "otile3", "otile4"]
        }).addTo(map);



        var layer_soil_wms_dem_mn = L.tileLayer.wms("http://opengeo.intetics.com.ua:8080/geoserver/soil/wms", {
            layers: 'soil:dem4326',
            format: 'image/png',
            styles: 'dem4326',
            opacity: 1,
            transparent: true
        });




/*        ﻿
        var popup = new L.Popup({
            maxWidth: 400
        });

        var GEO_URL = 'http://opengeo.intetics.com.ua:8080/geoserver/wms/';

        function onMapClick(e) {
            var latlngStr = '(' + e.latlng.lat.toFixed(3) + ', ' + e.latlng.lng.toFixed(3) + ')';
            var BBOX = map.getBounds()._southWest.lng + "," + map.getBounds()._southWest.lat + "," + map.getBounds()._northEast.lng + "," + map.getBounds()._northEast.lat;
            var WIDTH = map.getSize().x;
            var HEIGHT = map.getSize().y;
            var X = map.layerPointToContainerPoint(e.layerPoint).x;
            var Y = map.layerPointToContainerPoint(e.layerPoint).y;
            var LAYERS = 'soil:dem4326';
            var QUERY_LAYERS = 'soil:dem4326';
            var INFOFORMAT = 'text/html';
            var URL = GEO_URL + '?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=' + LAYERS + '&QUERY_LAYERS=' + QUERY_LAYERS + '&STYLES=&BBOX=' + BBOX + '&FEATURE_COUNT=5&HEIGHT=' + HEIGHT + '&WIDTH=' + WIDTH + '&FORMAT=image%2Fpng&INFO_FORMAT=' + INFOFORMAT + '&SRS=EPSG%3A4326&X=' + X + '&Y=' + Y;
            popup.setLatLng(e.latlng);

            popup.setContent("<iframe name=" + 'ifr' + " src='" + URL + "' width='600' height='100' frameborder='0'><p>Your browser does not support iframes.</p></iframe>");
            map.openPopup(popup);
        };


        map.on("overlayadd", function(e) {
            if (e.layer === layer_soil_wms_dem_mn) {
                map.addEventListener('click', onMapClick);
            }
        });


        map.on("overlayremove", function(e) {
            if (e.layer === layer_soil_wms_dem_mn) {
                map.removeEventListener('click', onMapClick);
                map.closePopup(popup);
            }
        });
*/




map.addEventListener('click', onMapClick);


 function onMapClick(e) {




        var mapBounds = map.getBounds()
            , bbox = map.getBounds()._southWest.lng + "," + map.getBounds()._southWest.lat + "," + map.getBounds()._northEast.lng + "," + map.getBounds()._northEast.lat;



 
         $.ajax({
            url : 'http://opengeo.intetics.com.ua:8080/geoserver/wms'
            , dataType : 'xml'
            , data : {
                'tiled': true
                , 'LAYERS': 'soil:dem4326'
                , 'QUERY_LAYERS': 'soil:dem4326'
                , 'STYLES': ''
                , 'SERVICE': 'WMS'
                , 'VERSION': '1.1.1'
                , 'REQUEST': 'GetFeatureInfo'
                , 'BBOX' : bbox
                , 'FEATURE_COUNT': '1'
                , 'WIDTH': map.getSize().x
                , 'HEIGHT': map.getSize().y 
                , 'FORMAT': 'image/png'
                , 'INFO_FORMAT': 'application/vnd.ogc.gml'
                , 'SRS': 'EPSG:4326'
                , 'X': map.layerPointToContainerPoint(e.layerPoint).x
                , 'Y': map.layerPointToContainerPoint(e.layerPoint).y
            }
        })
         .done(function(data){
		 
		 console.log(data);
		 /*
            if (data) {
                var $xml = $(data)
                    , original_coords = $xml.find('gml\\:coordinates').text().split(' ')
                    , koatuu = $xml.find('dzk\\:koatuu').text()       
                    , zone = $xml.find('dzk\\:zona').text()  
                    , quartal = $xml.find('dzk\\:kvartal').text() 
                    , parcel = $xml.find('dzk\\:parcel').text()   
                    , coords = [];
            }
			*/
			
			
        });
 



}; 
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		

        var overlayMaps = {
            "Rastr": layer_soil_wms_dem_mn
        };


        L.control.layers(null, overlayMaps, {
            collapsed: false
        }).addTo(map);
		
		
    </script>
</body>

</html>
